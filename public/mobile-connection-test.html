<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #2c7744;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        button {
            background-color: #4ded80;
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background-color: #3dc069;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        pre {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        .centered {
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4ded80;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .test-item {
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #4ded80;
        }
        .test-pending {
            border-left-color: #ffc107;
        }
        .test-success {
            border-left-color: #28a745;
        }
        .test-failed {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>HarvestLoop Mobile Connection Test</h1>
        <p>This page helps diagnose connection issues between your mobile device and the server</p>
    </div>

    <div class="card">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="info">Testing connection...</div>
        
        <div class="centered">
            <button onclick="runAllTests()">Run All Tests</button>
            <button class="btn-secondary" onclick="clearResults()">Clear Results</button>
        </div>
    </div>

    <div class="card">
        <h2>Connection Tests</h2>
        <div id="testLoader" class="loader"></div>
        
        <div id="testResults" class="test-grid">
            <!-- Test results will appear here -->
        </div>
    </div>
    
    <div class="card">
        <h2>Network Information</h2>
        <table>
            <tr>
                <th>Device Type</th>
                <td id="deviceType">Detecting...</td>
            </tr>
            <tr>
                <th>Browser</th>
                <td id="browserInfo">Detecting...</td>
            </tr>
            <tr>
                <th>Connection Type</th>
                <td id="connectionType">Detecting...</td>
            </tr>
            <tr>
                <th>Server URL</th>
                <td id="serverUrl">Detecting...</td>
            </tr>
            <tr>
                <th>Client IP</th>
                <td id="clientIp">Detecting...</td>
            </tr>
        </table>
    </div>

    <div class="card">
        <h2>Troubleshooting Tips</h2>
        <ul>
            <li>Ensure both devices are on the <strong>same WiFi network</strong></li>
            <li>Check your computer's <strong>firewall settings</strong> and allow Node.js</li>
            <li>Some public WiFi networks <strong>block device-to-device communication</strong></li>
            <li>Make sure you're using the complete URL with <strong>http://</strong> prefix</li>
            <li>If using a VPN on either device, try <strong>disabling it temporarily</strong></li>
            <li>On Windows, try <strong>running the server as administrator</strong></li>
        </ul>
    </div>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            detectEnvironment();
            testBasicConnection();
        });

        // Detect device and browser information
        function detectEnvironment() {
            // Detect device type
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            document.getElementById('deviceType').textContent = isMobile ? 'Mobile Device' : 'Desktop/Laptop';
            
            // Detect browser
            const browserInfo = getBrowserInfo();
            document.getElementById('browserInfo').textContent = browserInfo;
            
            // Detect connection type if available
            if ('connection' in navigator) {
                const conn = navigator.connection;
                let connectionInfo = conn.effectiveType || 'Unknown';
                if (conn.type) {
                    connectionInfo += ` (${conn.type})`;
                }
                document.getElementById('connectionType').textContent = connectionInfo;
            } else {
                document.getElementById('connectionType').textContent = 'Information not available';
            }
            
            // Show server URL
            document.getElementById('serverUrl').textContent = window.location.origin;
            
            // Try to get client IP
            fetch('/api/ping')
                .then(response => response.json())
                .then(data => {
                    if (data && data.clientIp) {
                        document.getElementById('clientIp').textContent = data.clientIp;
                    } else {
                        document.getElementById('clientIp').textContent = 'Not available from server';
                    }
                })
                .catch(() => {
                    document.getElementById('clientIp').textContent = 'Unable to retrieve';
                });
        }
        
        // Get browser information
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browserName = "Unknown";
            let browserVersion = "";
            
            if (ua.indexOf("Firefox") > -1) {
                browserName = "Firefox";
                browserVersion = ua.match(/Firefox\/([0-9.]+)/)[1];
            } else if (ua.indexOf("SamsungBrowser") > -1) {
                browserName = "Samsung Browser";
                browserVersion = ua.match(/SamsungBrowser\/([0-9.]+)/)[1];
            } else if (ua.indexOf("Opera") > -1 || ua.indexOf("OPR") > -1) {
                browserName = "Opera";
                browserVersion = ua.indexOf("Opera") > -1 ? ua.match(/Opera\/([0-9.]+)/)[1] : ua.match(/OPR\/([0-9.]+)/)[1];
            } else if (ua.indexOf("Trident") > -1) {
                browserName = "Internet Explorer";
                browserVersion = ua.match(/rv:([0-9.]+)/)[1];
            } else if (ua.indexOf("Edge") > -1) {
                browserName = "Edge (Legacy)";
                browserVersion = ua.match(/Edge\/([0-9.]+)/)[1];
            } else if (ua.indexOf("Edg") > -1) {
                browserName = "Edge Chromium";
                browserVersion = ua.match(/Edg\/([0-9.]+)/)[1];
            } else if (ua.indexOf("Chrome") > -1) {
                browserName = "Chrome";
                browserVersion = ua.match(/Chrome\/([0-9.]+)/)[1];
            } else if (ua.indexOf("Safari") > -1) {
                browserName = "Safari";
                browserVersion = ua.match(/Version\/([0-9.]+)/)[1];
            }
            
            return `${browserName} ${browserVersion}`;
        }

        // Basic connection test
        function testBasicConnection() {
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.className = 'info';
            connectionStatus.textContent = 'Testing connection to server...';
            
            fetch('/ping')
                .then(response => {
                    if (response.ok) {
                        connectionStatus.className = 'success';
                        connectionStatus.textContent = '✅ Connected to server successfully!';
                    } else {
                        connectionStatus.className = 'error';
                        connectionStatus.textContent = `❌ Server responded with status: ${response.status}`;
                    }
                })
                .catch(error => {
                    connectionStatus.className = 'error';
                    connectionStatus.textContent = `❌ Connection failed: ${error.message}`;
                });
        }

        // Run all tests
        function runAllTests() {
            document.getElementById('testLoader').classList.remove('hidden');
            document.getElementById('testResults').innerHTML = '';
            
            // Define all tests
            const tests = [
                { name: 'Basic Ping', endpoint: '/ping', method: 'GET' },
                { name: 'API Ping', endpoint: '/api/ping', method: 'GET' },
                { name: 'Static File', endpoint: '/assets/logo.png', method: 'GET' },
                { name: 'API Authentication', endpoint: '/api/auth/status', method: 'GET' },
                { name: 'Database Connection', endpoint: '/api/health/database', method: 'GET' },
                { name: 'WebSocket Test', type: 'websocket', endpoint: `ws://${window.location.host}/ws` }
            ];
            
            // Run each test and track progress
            let completedTests = 0;
            
            tests.forEach(test => {
                if (test.type === 'websocket') {
                    runWebSocketTest(test)
                        .finally(() => {
                            completedTests++;
                            if (completedTests === tests.length) {
                                document.getElementById('testLoader').classList.add('hidden');
                            }
                        });
                } else {
                    runFetchTest(test)
                        .finally(() => {
                            completedTests++;
                            if (completedTests === tests.length) {
                                document.getElementById('testLoader').classList.add('hidden');
                            }
                        });
                }
            });
        }

        // Run a fetch test
        function runFetchTest(test) {
            // Add pending test item
            const testItem = document.createElement('div');
            testItem.className = 'test-item test-pending';
            testItem.innerHTML = `
                <h3>${test.name}</h3>
                <p>Endpoint: ${test.endpoint}</p>
                <p>Status: Testing...</p>
            `;
            document.getElementById('testResults').appendChild(testItem);
            
            // Run the test
            return fetch(test.endpoint, { method: test.method })
                .then(response => {
                    testItem.className = 'test-item test-success';
                    testItem.innerHTML = `
                        <h3>${test.name}</h3>
                        <p>Endpoint: ${test.endpoint}</p>
                        <p>Status: ✅ Success (${response.status})</p>
                        <p>Time: ${new Date().toLocaleTimeString()}</p>
                    `;
                    return response;
                })
                .catch(error => {
                    testItem.className = 'test-item test-failed';
                    testItem.innerHTML = `
                        <h3>${test.name}</h3>
                        <p>Endpoint: ${test.endpoint}</p>
                        <p>Status: ❌ Failed</p>
                        <p>Error: ${error.message}</p>
                        <p>Time: ${new Date().toLocaleTimeString()}</p>
                    `;
                });
        }

        // Run a WebSocket test
        function runWebSocketTest(test) {
            return new Promise((resolve) => {
                // Add pending test item
                const testItem = document.createElement('div');
                testItem.className = 'test-item test-pending';
                testItem.innerHTML = `
                    <h3>${test.name}</h3>
                    <p>Endpoint: ${test.endpoint}</p>
                    <p>Status: Testing...</p>
                `;
                document.getElementById('testResults').appendChild(testItem);
                
                try {
                    const socket = new WebSocket(test.endpoint);
                    
                    socket.onopen = () => {
                        testItem.className = 'test-item test-success';
                        testItem.innerHTML = `
                            <h3>${test.name}</h3>
                            <p>Endpoint: ${test.endpoint}</p>
                            <p>Status: ✅ Connected</p>
                            <p>Time: ${new Date().toLocaleTimeString()}</p>
                        `;
                        socket.close();
                        resolve();
                    };
                    
                    socket.onerror = (error) => {
                        testItem.className = 'test-item test-failed';
                        testItem.innerHTML = `
                            <h3>${test.name}</h3>
                            <p>Endpoint: ${test.endpoint}</p>
                            <p>Status: ❌ Connection Failed</p>
                            <p>Time: ${new Date().toLocaleTimeString()}</p>
                        `;
                        resolve();
                    };
                    
                    // Timeout after 5 seconds
                    setTimeout(() => {
                        if (socket.readyState !== WebSocket.OPEN) {
                            socket.close();
                            testItem.className = 'test-item test-failed';
                            testItem.innerHTML = `
                                <h3>${test.name}</h3>
                                <p>Endpoint: ${test.endpoint}</p>
                                <p>Status: ❌ Connection Timeout</p>
                                <p>Time: ${new Date().toLocaleTimeString()}</p>
                            `;
                            resolve();
                        }
                    }, 5000);
                } catch (error) {
                    testItem.className = 'test-item test-failed';
                    testItem.innerHTML = `
                        <h3>${test.name}</h3>
                        <p>Endpoint: ${test.endpoint}</p>
                        <p>Status: ❌ Error: ${error.message}</p>
                        <p>Time: ${new Date().toLocaleTimeString()}</p>
                    `;
                    resolve();
                }
            });
        }

        // Clear all test results
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testBasicConnection();
        }
    </script>
</body>
</html>